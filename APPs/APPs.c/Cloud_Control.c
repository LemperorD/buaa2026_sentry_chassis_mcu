
/**
 * @file Cloud_control.c
 * @author Cyx
 * @brief
 * @version 0.1
 * @date 2023-08-15
 *
 * @copyright
 *
 */
#include "Cloud_Control.h"

/************?????ID***********/
positionpid_t J6006s_YawIPID;
positionpid_t J6006s_YawOPID;
positionpid_t AutoAim_J6006s_YawIPID;
positionpid_t AutoAim_J6006s_YawOPID;
/************?????ID END***********/

/****************??????????????????????*****************/
One_Kalman_t Cloud_YawMotorAngle_Error_Kalman;
One_Kalman_t Cloud_YawCurrent_Kalman;
One_Kalman_t Cloud_YawCurrent_Kalman_manul;
/****************?????????????????????? End*****************/
// ? Cloud_Control.c ?????????
Cloud_t Cloud;
extern Saber_Angle_t Saber_Angle;
float Control_Self_Yaw;

float shit;
uint8_t kk =8;
float Linear=1.75f;
float Setup_Angleoffset =0;
uint16_t first_flag = 0;
/********????????????********/
//MIT???????????????????
float J6006_Yaw_T = 1.0f; // ????yaw?????????????
float J6006_Yaw_P = 0.0f; 
float J6006_Yaw_V = 0.0f;
float J6006_Yaw_Kp = 0.0f; //???????????????KP??????????????????
float J6006_Yaw_Kd = 1.0f;
float yaw_angle_last;
float chassis_yaw_last = 0.0f;
float chassis_yaw_unwrapped = 0.0f;
int8_t follow_cloud;
int32_t chassis_turns = 0;
int32_t Info_flag=0;
int32_t flag5=0;
int32_t flag6=0;
int32_t flag_Angle_Cloud=0;
/***************?????????????****
 * ***********/
Cloud_FUN_t Cloud_FUN = Cloud_FUNGroundInit;
#undef Cloud_FUNGroundInit

/**
 * @brief ???????g?
 * @param angle ???????????L??
 * @param ?????1
 * @param kp
 * @retval ????????????????
 */
void chassis_follow_mode_cloud(uint8_t start_flag)
{
	if(start_flag)
    {
		 	if(J6006s_Yaw.InfoUpdateFrame < 30 && Info_flag == 0)
    	{
	    	Cloud.Target_Yaw = Saber_Angle.Yaw /360.0f *8192.0f + follow_mode_angle;
	    	Info_flag++;
	    }
    }
		else
		{
	  	if(J6006s_Yaw.InfoUpdateFrame < 30 && Info_flag == 0)
	   {
		   Cloud.Target_Yaw = Saber_Angle.Yaw /360.0f *8192.0f + J6006s_Yaw.realAngle6006;
	    	Info_flag++;
	   }
		}
}

/**
 * @brief  ???????????????????????????????????
 * @param  None
 * @retval None
 */
void Cloud_Init(void)
{
	//???????????????????????????????????
	Cloud.Target_Yaw = Saber_Angle.Yaw /360.0f *8192.0f + J6006s_Yaw.realAngle6006 ;   //?????????????????
	//MIT???????????????????
	DM_MIT_Init(&J6006s_Yaw,J6006_Yaw_T,J6006_Yaw_P,J6006_Yaw_V,J6006_Yaw_Kp,J6006_Yaw_Kd);
  Big_Yaw_Angle=J6006s_Yaw.realAngle6006 - Saber_Angle.Yaw /360.0f *8192.0f ;
	//???????????????????????
	Cloud.Target_Yaw = J6006s_Yaw.realAngle6006 + Saber_Angle.Yaw /360.0f *  8192.0f; 

	One_Kalman_Create(&Cloud_YawMotorAngle_Error_Kalman, 1, 10);
	One_Kalman_Create(&Cloud_YAWODKalman, 1, 10);
	One_Kalman_Create(&Cloud_YawCurrent_Kalman, 1, 6);
	One_Kalman_Create(&Cloud_YawCurrent_Kalman_manul, 1, 6);
}
/**
  * @brief  M6020_Yaw?????ID?????
  * @param  void
  * @retval void
  * @attention
  */
void PID_Clear_Yaw(void)
{
	Clear_PositionPIDData(&J6006s_YawOPID);
	Clear_PositionPIDData(&AutoAim_J6006s_YawOPID);
}


/**
  * @brief  M6020_Yaw???????????????????????????????????????????????????
  * @param  void
  * @retval void
  * @attention
  */

void Cloud_Yaw_Angle_Set(void)
{
	/**************************????Yaw6020???????????????????*****************************/
	
	chassis_follow_mode_cloud(follow_cloud);
	static uint8_t time=5;
	
	while (Cloud.Target_Yaw > 8192)
	{
		Cloud.Target_Yaw -= 8192;
	}
	while (Cloud.Target_Yaw < 0)
	{
		Cloud.Target_Yaw += 8192;
	}
	
	/**************************Yaw???????????o????????????????????????*****************/
	float Angle_Yaw_Real = Saber_Angle.Yaw /360.0f *  8192.0f ;/* 8192/360*/  //??????yaw??????????????????
	Big_Yaw_Angle=J6006s_Yaw.realAngle6006 - Saber_Angle.Yaw /360.0f *8192.0f ;
	float diff = Angle_Yaw_Real - chassis_yaw_last;
	if(diff < -4096.0f) {
        chassis_turns++; // ????€??
    }
    // ?? 10 -> 8190, diff ??? +8180 (??? +4096)
    else if (diff > 4096.0f) {
        chassis_turns--; // ????€??
    }
	chassis_yaw_unwrapped = Angle_Yaw_Real + chassis_turns * 8192.0f;
    chassis_yaw_last = Angle_Yaw_Real; // ?????????????€?????
//	float Angle_Err_Yaw =  J6006s_Yaw.realAngle - 1.011395*chassis_yaw_unwrapped;	          //????yaw??????????????????
	float Angle_Err_Yaw =  J6006s_Yaw.realAngle6006 - chassis_yaw_unwrapped;
	/*Err??-4096 ~ 8192+4096???Target? 0 ~ 8191??????????????Err? -4096 ~ 4096 */
	/*???????????????*/
	while (Angle_Err_Yaw > 4096 )
	{
		Angle_Err_Yaw -= 8192 ;
	}
	ControlMes.yaw_realAngle = Angle_Err_Yaw;
	
	//Gimbal_Chassis_Pitch_Translate();    //?????????????itch??????????????          
	
	float Delta_Yaw = Angle_Err_Yaw - Cloud.Target_Yaw + Linear*Saber_Angle.Z_Vel  ;
	
	
	/*Derta???? -4096-8191 ~ 4096*/
	while ( Delta_Yaw <=  -4096)
	{
		Delta_Yaw +=8192;
	}

	/*???????????????????????????????????????*/ /*Target_xxx????????*/

	if(ControlMes.AutoAimFlag==0)
	{
					/*??????*/
			if(Delta_Yaw < 10 && Delta_Yaw > -10)
			{
				Delta_Yaw = 0;
			}
			/*??????????*/
		  Delta_Yaw = One_Kalman_Filter(&Cloud_YawMotorAngle_Error_Kalman, Delta_Yaw);
			if( time >= kk )
			{
				J6006s_Yaw.outSpeed = Position_PID(&J6006s_YawOPID,  0 ,Delta_Yaw);	
				time = 0;
			}
			J6006s_Yaw.outTorque = Position_PID_Yaw(&J6006s_YawIPID, &FuzzyPID_Yaw, J6006s_Yaw.outSpeed, J6006s_Yaw.realSpeed);
			J6006s_Yaw.outTorque = One_Kalman_Filter(&Cloud_YawCurrent_Kalman_manul, J6006s_Yaw.outTorque);
			time ++;
	}
	else if(ControlMes.AutoAimFlag==1)
	{
		  J6006s_Yaw.outSpeed = Position_PID(&AutoAim_J6006s_YawOPID,  0 ,Delta_Yaw);	
      J6006s_Yaw.outTorque = Position_PID_Yaw(&AutoAim_J6006s_YawIPID, &FuzzyPID_AimYaw, J6006s_Yaw.outSpeed, J6006s_Yaw.realSpeed);
		  J6006s_Yaw.outTorque = One_Kalman_Filter(&Cloud_YawCurrent_Kalman, J6006s_Yaw.outTorque);
	}
}
/**
  * @brief  M6020?????????
  * @param  void
  * @retval void
  * @attention
  */
void Cloud_Sport_Out(void)
{
	    /**********?????????????????????**********/
		if(ControlMes.modelFlag == model_Record)
		{
			J6006s_Yaw.InfoUpdateFrame = 0;
			return;
		}
		else if(J6006s_Yaw.InfoUpdateFlag == 1)
		{
			Cloud_FUN.Cloud_Yaw_Angle_Set();
		}
		else
		{
			return;
		}
	/**********??????Yaw?????????????**********/
	  float Angle_Cloud = J6006s_Yaw.realAngle6006;
		Angle_Cloud = J6006s_Yaw.realAngle6006 +Setup_Angleoffset;
		flag_Angle_Cloud=Angle_Cloud;
		if(Angle_Cloud > 4096)
		{
			Angle_Cloud -= 8192;
		}
	Steer_Omni_GetAngle((-1)*Angle_Cloud/8192.0f*360+180);
}


